{% extends "base.html" %}
{% load static %}
{% block title %}Billing — Stays{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">Billing — Stays</h3>
    <div class="small text-muted">
      Summary of all stays with generated bills (total_due &gt; 0)
    </div>
  </div>

  <div class="text-end small">
    <div>Total stays: <strong>{{ total_stays }}</strong></div>
    <div>Total billed: <strong>₹ {{ total_billed }}</strong></div>
    <div>Total paid: <strong>₹ {{ total_paid }}</strong></div>
    <div>Outstanding: <strong>₹ {{ total_due_out }}</strong></div>
  </div>
</div>

<!-- Filters -->
<form method="get" class="card mb-3">
  <div class="card-body row g-2 align-items-end">
    <div class="col-6 col-md-3">
      <label class="form-label mb-1">From date</label>
      <input type="date" name="start" class="form-control form-control-sm" value="{{ start }}">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label mb-1">To date</label>
      <input type="date" name="end" class="form-control form-control-sm" value="{{ end }}">
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label mb-1">Paid status</label>
      <select name="paid" class="form-select form-select-sm">
        <option value="">All</option>
        <option value="paid" {% if paid == "paid" %}selected{% endif %}>Paid</option>
        <option value="unpaid" {% if paid == "unpaid" %}selected{% endif %}>Unpaid</option>
      </select>
    </div>
    <div class="col-6 col-md-3">
      <label class="form-label mb-1">Search</label>
      <input type="text" name="q" class="form-control form-control-sm"
             placeholder="Guest / phone / room / invoice"
             value="{{ q }}">
    </div>

    <div class="col-12 d-flex justify-content-end gap-2 mt-2">
      <a href="{% url 'portal_billing_list' %}" class="btn btn-sm btn-outline-secondary">
        Clear
      </a>
      <button class="btn btn-sm btn-primary">Apply</button>
    </div>
  </div>
</form>

<!-- Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>Invoice</th>
            <th>Room</th>
            <th>Guest</th>
            <th>Phone</th>
            <th>Created</th>
            <th class="text-end">Total (₹)</th>
            <th>Status</th>
            <th>Payment</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% if page_obj.object_list %}
            {% for st in page_obj.object_list %}
              <tr>
                <td>
                  {% if st.invoice_no %}
                    <span class="badge text-bg-light text-dark">{{ st.invoice_no }}</span>
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
                <td>Room {{ st.room.number }}</td>
                <td>{{ st.guest_name|default:"—" }}</td>
                <td>{{ st.phone|default:"—" }}</td>
                <td class="small">
                  {{ st.created_at|date:"d M Y, H:i" }}
                </td>
                <td class="text-end fw-semibold">
                  {{ st.total_due }}
                </td>
                <td>
                  {% if st.is_paid %}
                    <span class="badge text-bg-success">Paid</span>
                  {% else %}
                    <span class="badge text-bg-warning text-dark">Unpaid</span>
                  {% endif %}
                </td>
                <td class="small">
                  {% if st.payment_mode %}
                    {{ st.payment_mode }}
                    {% if st.paid_at %}
                      <br><span class="text-muted">{{ st.paid_at|date:"d M, H:i" }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <a href="{% url 'portal_stays_history' %}?q={{ st.room.number }}" class="btn btn-sm btn-outline-secondary">
                    Stay
                  </a>
                  <a href="{% url 'portal_stay_invoice' st.id %}" target="_blank"
                     class="btn btn-sm btn-primary">
                    Invoice
                  </a>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                No billed stays match the current filters.
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Pagination footer -->
  <div class="card-footer py-2">
    <nav aria-label="Billing pagination">
      <ul class="pagination pagination-sm mb-0 justify-content-end">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&start={{ start }}&end={{ end }}&paid={{ paid }}&q={{ q }}">«</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">«</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}&start={{ start }}&end={{ end }}&paid={{ paid }}&q={{ q }}">»</a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">»</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}
