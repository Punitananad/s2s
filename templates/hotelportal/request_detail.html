{% extends "base.html" %}
{% block title %}Request #{{ r.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h3 class="mb-1">Request #{{ r.id }} — Room {{ r.room.number }}</h3>
    <div class="small text-muted">
      {% if r.kind == "FOOD" %}
        <span class="badge text-bg-primary">FOOD</span>
      {% else %}
        <span class="badge text-bg-info">SERVICE</span>
      {% endif %}
      {% if r.status == "NEW" %}
        <span class="badge text-bg-secondary ms-1">NEW</span>
      {% elif r.status == "ACCEPTED" %}
        <span class="badge text-bg-warning ms-1">ACCEPTED</span>
      {% elif r.status == "COMPLETED" %}
        <span class="badge text-bg-success ms-1">COMPLETED</span>
      {% else %}
        <span class="badge text-bg-dark ms-1">CANCELLED</span>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'portal_requests_history' %}">Back to History</a>
    <a
      class="btn btn-outline-primary btn-sm"
      href="{% url 'portal_request_detail' r.id %}?print=slip"
      target="_blank" rel="noopener"
    >Print slip</a>
    <button class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
  </div>
</div>

<dl class="row small">
  <dt class="col-3">Created</dt><dd class="col-9">{{ r.created_at|date:"d M Y, H:i" }}</dd>
  {% if r.accepted_at %}<dt class="col-3">Accepted</dt><dd class="col-9">{{ r.accepted_at|date:"d M Y, H:i" }}</dd>{% endif %}
  {% if r.completed_at %}<dt class="col-3">Completed</dt><dd class="col-9">{{ r.completed_at|date:"d M Y, H:i" }}</dd>{% endif %}
  {% if r.cancelled_at %}<dt class="col-3">Cancelled</dt><dd class="col-9">{{ r.cancelled_at|date:"d M Y, H:i" }}</dd>{% endif %}
</dl>

{% if r.note %}
  <div class="alert alert-warning py-2 px-3 mb-3">
    <div class="small text-uppercase text-muted fw-semibold mb-1">Customer note</div>
    <div class="mb-0" style="white-space:pre-wrap">{{ r.note }}</div>
  </div>
{% endif %}

{% if r.kind == "FOOD" %}
  <h5 class="mt-3">Items</h5>
  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr><th>Item</th><th class="text-end">Qty</th><th class="text-end">Line Total</th></tr>
      </thead>
      <tbody>
        {% for ln in r.lines.all %}
          <tr>
            <td>{{ ln.name_snapshot }}</td>
            <td class="text-end">{{ ln.qty }}</td>
            <td class="text-end">₹ {{ ln.line_total }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="text-muted">No lines.</td></tr>
        {% endfor %}
      </tbody>
      <tfoot class="table-light">
        <tr><th colspan="2" class="text-end">Subtotal</th><th class="text-end">₹ {{ r.subtotal }}</th></tr>
      </tfoot>
    </table>
  </div>
{% else %}
  <h5 class="mt-3">Service</h5>
  <div class="border rounded p-2">
    {% if r.service_item %}{{ r.service_item.name }}{% else %}Service{% endif %}
    {% if r.note %}{% if r.service_item %} — {% endif %}{{ r.note }}{% endif %}
  </div>
  {% if r.subtotal %}
    <div class="d-flex justify-content-between mt-2">
      <strong>Amount</strong><strong>₹ {{ r.subtotal }}</strong>
    </div>
  {% endif %}
{% endif %}
{% endblock %}
